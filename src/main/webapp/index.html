<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>방탈출: 잠긴 서버실</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#0c1220;
      --line:#1b2a44;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --accent:#7aa2ff;
      --good:#43d19e;
      --bad:#ff5a7a;
      --warn:#ffd66b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius:16px;
      --radius2:12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple SD Gothic Neo", "Noto Sans KR", "Malgun Gothic", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 700px at -10% 20%, rgba(67,209,158,.14), transparent 55%),
        radial-gradient(700px 600px at 30% 110%, rgba(255,90,122,.12), transparent 55%),
        linear-gradient(180deg, #070a11 0%, var(--bg) 60%, #070a11 100%);
      overflow-x:hidden;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:22px 18px 40px;
    }
    header{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .badge{
      width:42px; height:42px;
      border-radius:12px;
      background: linear-gradient(135deg, rgba(122,162,255,.35), rgba(67,209,158,.25));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      position:relative;
    }
    .badge:before{
      content:"";
      position:absolute; inset:10px 12px 12px 10px;
      border:1px dashed rgba(255,255,255,.25);
      border-radius:10px;
      transform:rotate(-6deg);
    }
    h1{
      font-size:18px;
      letter-spacing:-0.2px;
      margin:0;
      line-height:1.15;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .chip{
      display:flex;
      gap:8px;
      align-items:center;
      padding:9px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chip b{color:var(--text); font-weight:600}
    .chip .dot{
      width:7px;height:7px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,.15);
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .btn:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.22);}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(122,162,255,.25), rgba(122,162,255,.10));
      border-color: rgba(122,162,255,.35);
    }
    .btn.danger{
      background: linear-gradient(135deg, rgba(255,90,122,.22), rgba(255,90,122,.08));
      border-color: rgba(255,90,122,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap:16px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .panel:before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(700px 400px at 20% 0%, rgba(122,162,255,.10), transparent 60%),
                  radial-gradient(600px 380px at 90% 30%, rgba(67,209,158,.08), transparent 55%);
      pointer-events:none;
      opacity:.8;
    }
    .panel .hd{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      padding:16px 16px 10px;
      position:relative;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(8,12,20,.55);
      backdrop-filter: blur(10px);
    }
    .panel .hd h2{
      margin:0;
      font-size:14px;
      letter-spacing:-0.2px;
    }
    .panel .hd p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      max-width:66ch;
    }
    .panel .bd{
      padding:16px;
      position:relative;
    }

    .room{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 720px){
      .room{grid-template-columns:1fr;}
    }

    .card{
      background: linear-gradient(180deg, rgba(15,22,36,.65), rgba(10,16,28,.55));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius2);
      padding:14px;
      position:relative;
      overflow:hidden;
      min-height:150px;
    }
    .card:before{
      content:"";
      position:absolute; inset:-60px -80px auto auto;
      width:180px;height:180px;
      background: radial-gradient(circle at 30% 30%, rgba(122,162,255,.22), transparent 60%);
      transform: rotate(15deg);
      pointer-events:none;
      opacity:.8;
    }
    .card h3{
      margin:0 0 10px;
      font-size:13px;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .tag{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--muted);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
      min-width:180px;
    }
    label{
      font-size:11px;
      color:var(--muted);
    }
    input[type="text"], input[type="password"], input[type="number"]{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      transition: border-color .15s ease, background .15s ease;
    }
    input:focus{
      border-color: rgba(122,162,255,.55);
      background: rgba(0,0,0,.22);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .hint b{color:var(--text)}
    .mono{font-family:var(--mono)}
    .divider{
      height:1px;
      background: rgba(255,255,255,.08);
      margin:12px 0;
    }

    .status{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      margin-top:12px;
    }
    .status .lamp{
      width:10px;height:10px;border-radius:50%;
      margin-top:4px;
      box-shadow: 0 0 0 5px rgba(255,255,255,.06);
      background: var(--warn);
    }
    .status.good .lamp{background: var(--good); box-shadow: 0 0 0 5px rgba(67,209,158,.14);}
    .status.bad .lamp{background: var(--bad); box-shadow: 0 0 0 5px rgba(255,90,122,.14);}
    .status .txt{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .status .txt b{color:var(--text)}
    .status .txt .small{display:block; margin-top:4px; opacity:.95}

    .side{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .inventory{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .item{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .item:hover{background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.18);}
    .item:active{transform: translateY(1px)}
    .item .ico{
      width:26px;height:26px;border-radius:10px;
      display:grid; place-items:center;
      background: rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.25);
      color: var(--accent);
      font-weight:800;
      font-family:var(--mono);
    }
    .locked{
      opacity:.5;
      filter: saturate(.8);
      cursor:not-allowed;
    }

    .log{
      font-family:var(--mono);
      font-size:11px;
      line-height:1.5;
      color: rgba(232,238,252,.82);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
      max-height:260px;
      overflow:auto;
      white-space:pre-wrap;
    }

    .modal{
      position:fixed;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      z-index:40;
      padding:18px;
    }
    .modal.open{display:grid;}
    .dialog{
      width:min(740px, 100%);
      background: linear-gradient(180deg, rgba(16,23,38,.96), rgba(10,16,28,.94));
      border:1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 35px 120px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .dialog .top{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .dialog .top h4{
      margin:0;
      font-size:13px;
      letter-spacing:-0.2px;
    }
    .dialog .content{
      padding:16px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .dialog .content b{color:var(--text)}
    .dialog .actions{
      padding:14px 16px 16px;
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .shake{
      animation: shake .28s ease-in-out 0s 1;
    }
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    .spark{
      position:fixed;
      pointer-events:none;
      inset:0;
      overflow:hidden;
      z-index:50;
      display:none;
    }
    .spark.show{display:block;}
    .confetti{
      position:absolute;
      width:9px;height:14px;
      opacity:.9;
      border-radius:3px;
      transform: translateY(-20px);
      animation: fall 1.6s ease-in forwards;
    }
    @keyframes fall{
      to{
        transform: translateY(calc(100vh + 40px)) rotate(540deg);
        opacity: 0.95;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="badge" aria-hidden="true"></div>
        <div>
          <h1>방탈출: 잠긴 서버실</h1>
          <div class="sub">단서 3개를 모아 출입문 잠금을 해제하세요.</div>
        </div>
      </div>
      <div class="topbar">
        <div class="chip" id="chipTimer"><span class="dot"></span>남은 시간 <b id="timeLeft">15:00</b></div>
        <div class="chip"><span class="dot" style="background:var(--good); box-shadow:0 0 0 4px rgba(67,209,158,.14)"></span>진행 <b id="progress">0/3</b></div>
        <button class="btn" id="btnHelp">힌트</button>
        <button class="btn danger" id="btnReset">리셋</button>
      </div>
    </header>

    <div class="grid">
      <section class="panel">
        <div class="hd">
          <div>
            <h2>서버실 내부</h2>
            <p>
              네가 들어온 문이 자동으로 잠겼다. <b>보안 패널</b>에 3개의 코드를 입력해야 문이 열린다.
              각 퍼즐을 풀고 아이템을 모아 <span class="mono">LOCK-3</span>를 해제하자.
            </p>
          </div>
          <div class="tag">난이도: ★★☆</div>
        </div>
        <div class="bd">
          <div class="room">
            <!-- Puzzle 1 -->
            <div class="card" id="card1">
              <h3>① 라벨 프린터 <span class="tag">숫자 키</span></h3>
              <div class="hint">
                프린터 옆 메모: <b>“오전 9시에 시작, 15분마다 1칸”</b><br/>
                종이에는 이런 그리드가 인쇄되어 있다:
              </div>
              <div class="divider"></div>
              <div class="hint mono">
                09:00  □<br/>
                09:15  □□<br/>
                09:30  □□□<br/>
                09:45  □□□□<br/>
                10:00  □□□□□
              </div>
              <div class="divider"></div>
              <div class="row">
                <div class="field">
                  <label for="p1">빈칸 개수 규칙이 의미하는 숫자(정답은 5자리)</label>
                  <input id="p1" type="text" inputmode="numeric" placeholder="예: 09150" maxlength="5" />
                </div>
                <button class="btn primary" id="p1btn">확인</button>
              </div>
              <div class="status" id="p1status">
                <div class="lamp"></div>
                <div class="txt">
                  <b>목표</b>: 규칙대로 “다음 줄”을 예측해 숫자로 입력.<span class="small">힌트: 시간은 그대로 쓰고, 칸 수를 숫자로 붙여라.</span>
                </div>
              </div>
            </div>

            <!-- Puzzle 2 -->
            <div class="card" id="card2">
              <h3>② 랙 전면 패널 <span class="tag">문자 키</span></h3>
              <div class="hint">
                랙에 스티커: <b>“SHIFT는 거짓말을 한다”</b><br/>
                콘솔 화면에는 아래 문장이 있다:
              </div>
              <div class="divider"></div>
              <div class="hint mono" style="opacity:.95">
                IF YOU CAN READ THIS, TYPE THE <b>THIRD WORD</b> ONLY.
              </div>
              <div class="divider"></div>
              <div class="row">
                <div class="field">
                  <label for="p2">세 번째 단어(대문자/소문자 상관없음)</label>
                  <input id="p2" type="text" placeholder="예: CAN" />
                </div>
                <button class="btn primary" id="p2btn">확인</button>
              </div>
              <div class="status" id="p2status">
                <div class="lamp"></div>
                <div class="txt">
                  <b>목표</b>: 문장 속 세 번째 단어만 입력.<span class="small">힌트: 쉼표/괄호 없이 단어만.</span>
                </div>
              </div>
            </div>

            <!-- Puzzle 3 -->
            <div class="card" id="card3">
              <h3>③ 비상 전원함 <span class="tag">패턴 키</span></h3>
              <div class="hint">
                전원함 내부에 4개의 스위치가 있고, 아래 순서대로 켜라고 적혀 있다.
              </div>
              <div class="divider"></div>
              <div class="hint mono">
                A = 1, B = 2, C = 3, D = 4<br/>
                Sequence: B → D → A → C
              </div>
              <div class="divider"></div>
              <div class="row">
                <div class="field">
                  <label for="p3">순서를 숫자로만 입력 (예: 2413)</label>
                  <input id="p3" type="text" inputmode="numeric" placeholder="예: 2413" maxlength="4" />
                </div>
                <button class="btn primary" id="p3btn">확인</button>
              </div>
              <div class="status" id="p3status">
                <div class="lamp"></div>
                <div class="txt">
                  <b>목표</b>: 문자→숫자 매핑 후 순서를 숫자로 작성.<span class="small">힌트: B=2, D=4, A=1, C=3.</span>
                </div>
              </div>
            </div>

            <!-- Door -->
            <div class="card" id="cardDoor">
              <h3>출입문 보안 패널 <span class="tag">LOCK-3</span></h3>
              <div class="hint">
                아이템 3개를 모으면 패널이 활성화된다. 코드를 입력해 잠금을 해제하자.
              </div>
              <div class="divider"></div>

              <div class="row">
                <div class="field">
                  <label for="k1">키 1 (숫자 5자리)</label>
                  <input id="k1" type="text" inputmode="numeric" maxlength="5" placeholder="_____"/>
                </div>
                <div class="field">
                  <label for="k2">키 2 (단어)</label>
                  <input id="k2" type="text" placeholder="_____"/>
                </div>
              </div>
              <div class="row" style="margin-top:10px">
                <div class="field">
                  <label for="k3">키 3 (숫자 4자리)</label>
                  <input id="k3" type="text" inputmode="numeric" maxlength="4" placeholder="____"/>
                </div>
                <button class="btn primary" id="doorBtn">잠금 해제</button>
              </div>

              <div class="status" id="doorStatus">
                <div class="lamp"></div>
                <div class="txt">
                  <b>상태</b>: 잠김. <span class="small">3개 키가 모두 맞으면 문이 열린다.</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <aside class="side">
        <section class="panel">
          <div class="hd">
            <div>
              <h2>인벤토리</h2>
              <p>퍼즐을 풀면 키가 여기에 추가된다. 아이템을 눌러 설명을 확인해라.</p>
            </div>
            <div class="tag">아이템</div>
          </div>
          <div class="bd">
            <div class="inventory" id="inv">
              <div class="item locked" id="it1" data-item="1">
                <div class="ico">1</div>
                <div>키 1</div>
              </div>
              <div class="item locked" id="it2" data-item="2">
                <div class="ico">2</div>
                <div>키 2</div>
              </div>
              <div class="item locked" id="it3" data-item="3">
                <div class="ico">3</div>
                <div>키 3</div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="hint">
              <b>팁</b>: 키는 보안 패널에 직접 입력할 수도 있고, 인벤토리에서 클릭해 자동 입력할 수도 있어.
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="hd">
            <div>
              <h2>상황 로그</h2>
              <p>네 행동이 기록된다. 막히면 여기부터 봐.</p>
            </div>
            <div class="tag mono" id="seedTag">SEED</div>
          </div>
          <div class="bd">
            <div class="log" id="log"></div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal" id="modal">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="top">
        <h4 id="helpTitle">힌트 모음</h4>
        <button class="btn" id="btnClose">닫기</button>
      </div>
      <div class="content" id="helpContent">
        <b>① 라벨 프린터</b> — 시간(4자리) + 칸수(1자리)를 붙이면 5자리. 다음 줄은 <span class="mono">10:15</span>에서 칸이 6개.<br/><br/>
        <b>② 랙 전면 패널</b> — “IF(1) YOU(2) CAN(3) ...” 세 번째 단어만.<br/><br/>
        <b>③ 비상 전원함</b> — 문자→숫자 변환 후 순서를 그대로.
      </div>
      <div class="actions">
        <button class="btn primary" id="btnHintFill">힌트로 자동 채우기(1회)</button>
      </div>
    </div>
  </div>

  <!-- Victory Confetti -->
  <div class="spark" id="spark"></div>

  <script>
    (function(){
      // ---------- State ----------
      const state = {
        timerSec: 15*60,
        running: true,
        solved: { p1:false, p2:false, p3:false },
        keys: { k1:"", k2:"", k3:"" },
        hintUsed: false,
        seed: Math.random().toString(16).slice(2, 8).toUpperCase()
      };

      // Answers (keep simple)
      // Puzzle 1: "time(4 digits) + count(1 digit) for NEXT line"
      // Next line after 10:00 with 5 boxes is 10:15 with 6 boxes -> 10156
      const ANSWERS = {
        p1: "10156",
        p2: "CAN",
        p3: "2413",
      };

      // Derived keys (could be same as answers)
      const KEYS = {
        k1: ANSWERS.p1,
        k2: ANSWERS.p2,
        k3: ANSWERS.p3
      };

      // ---------- DOM ----------
      const $ = (id)=>document.getElementById(id);
      const logEl = $("log");
      const timeEl = $("timeLeft");
      const progressEl = $("progress");
      const seedTag = $("seedTag");
      seedTag.textContent = "SEED " + state.seed;

      // Inputs/buttons
      const p1 = $("p1"), p2 = $("p2"), p3 = $("p3");
      const p1btn = $("p1btn"), p2btn = $("p2btn"), p3btn = $("p3btn");
      const p1status = $("p1status"), p2status = $("p2status"), p3status = $("p3status");

      const k1 = $("k1"), k2 = $("k2"), k3 = $("k3");
      const doorBtn = $("doorBtn"), doorStatus = $("doorStatus");

      const it1 = $("it1"), it2 = $("it2"), it3 = $("it3");
      const inv = $("inv");

      const modal = $("modal");
      const btnHelp = $("btnHelp");
      const btnClose = $("btnClose");
      const btnHintFill = $("btnHintFill");
      const btnReset = $("btnReset");
      const spark = $("spark");

      // ---------- Utils ----------
      function pad2(n){ return String(n).padStart(2,"0"); }
      function formatTime(sec){
        const m = Math.floor(sec/60);
        const s = sec%60;
        return `${pad2(m)}:${pad2(s)}`;
      }
      function writeLog(msg, tone="info"){
        const stamp = new Date().toLocaleTimeString("ko-KR", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
        const prefix = tone==="good" ? "✓" : tone==="bad" ? "✗" : tone==="warn" ? "!" : "•";
        logEl.textContent = `${prefix} [${stamp}] ${msg}\n` + logEl.textContent;
      }
      function setStatus(el, kind, title, small){
        el.classList.remove("good","bad");
        if(kind==="good") el.classList.add("good");
        if(kind==="bad") el.classList.add("bad");
        el.querySelector(".txt").innerHTML = `<b>${title}</b><span class="small">${small || ""}</span>`;
      }
      function updateProgress(){
        const done = Object.values(state.solved).filter(Boolean).length;
        progressEl.textContent = `${done}/3`;
      }
      function unlockItem(n){
        const it = n===1?it1:n===2?it2:it3;
        it.classList.remove("locked");
        it.querySelector(".ico").style.background = "rgba(67,209,158,.14)";
        it.querySelector(".ico").style.borderColor = "rgba(67,209,158,.35)";
        it.querySelector(".ico").style.color = "var(--good)";
      }
      function autoFillDoor(n){
        if(n===1) k1.value = KEYS.k1;
        if(n===2) k2.value = KEYS.k2;
        if(n===3) k3.value = KEYS.k3;
        writeLog(`인벤토리에서 키 ${n}를 패널에 입력했어.`, "info");
      }
      function shake(el){
        el.classList.remove("shake");
        void el.offsetWidth;
        el.classList.add("shake");
      }
      function celebrate(){
        spark.innerHTML = "";
        spark.classList.add("show");
        const colors = [
          "rgba(122,162,255,.95)",
          "rgba(67,209,158,.95)",
          "rgba(255,90,122,.95)",
          "rgba(255,214,107,.95)",
          "rgba(232,238,252,.95)",
        ];
        for(let i=0;i<120;i++){
          const c = document.createElement("div");
          c.className = "confetti";
          c.style.left = (Math.random()*100) + "vw";
          c.style.top = (-10 - Math.random()*30) + "px";
          c.style.background = colors[(Math.random()*colors.length)|0];
          c.style.animationDelay = (Math.random()*0.25) + "s";
          c.style.animationDuration = (1.3 + Math.random()*0.9) + "s";
          c.style.transform = `translateY(-20px) rotate(${Math.random()*180}deg)`;
          spark.appendChild(c);
        }
        setTimeout(()=>spark.classList.remove("show"), 2200);
      }

      // ---------- Timer ----------
      function tick(){
        if(!state.running) return;
        state.timerSec--;
        timeEl.textContent = formatTime(state.timerSec);
        if(state.timerSec <= 0){
          state.running = false;
          timeEl.textContent = "00:00";
          writeLog("시간 초과! 문이 더 단단히 잠겼어. 리셋해서 다시 도전해.", "bad");
          setStatus(doorStatus, "bad", "상태: 실패", "시간이 다 됐다. 리셋해서 다시 시작해.");
          doorBtn.disabled = true;
          doorBtn.classList.add("locked");
        }
      }
      timeEl.textContent = formatTime(state.timerSec);
      const timer = setInterval(tick, 1000);

      // ---------- Puzzle Checkers ----------
      function checkP1(){
        const v = (p1.value||"").trim();
        if(v === ANSWERS.p1){
          if(!state.solved.p1){
            state.solved.p1 = true;
            state.keys.k1 = KEYS.k1;
            unlockItem(1);
            updateProgress();
            writeLog(`퍼즐 ① 해결! 키 1을 획득했다. (키1: ${state.keys.k1})`, "good");
          }else{
            writeLog("퍼즐 ①은 이미 해결했어.", "info");
          }
          setStatus(p1status, "good", "퍼즐 ① 성공", "키 1이 인벤토리에 추가됐다.");
        }else{
          writeLog("퍼즐 ① 오답. 규칙을 다시 봐.", "bad");
          setStatus(p1status, "bad", "퍼즐 ① 오답", "시간(4자리)+칸수(1자리)로 다음 줄을 써야 해.");
          shake($("card1"));
        }
      }
      function checkP2(){
        const v = (p2.value||"").trim().toUpperCase();
        if(v === ANSWERS.p2){
          if(!state.solved.p2){
            state.solved.p2 = true;
            state.keys.k2 = KEYS.k2;
            unlockItem(2);
            updateProgress();
            writeLog(`퍼즐 ② 해결! 키 2를 획득했다. (키2: ${state.keys.k2})`, "good");
          }else{
            writeLog("퍼즐 ②는 이미 해결했어.", "info");
          }
          setStatus(p2status, "good", "퍼즐 ② 성공", "키 2가 인벤토리에 추가됐다.");
        }else{
          writeLog("퍼즐 ② 오답. 세 번째 단어만 입력해야 해.", "bad");
          setStatus(p2status, "bad", "퍼즐 ② 오답", "문장의 세 번째 단어만 써.");
          shake($("card2"));
        }
      }
      function checkP3(){
        const v = (p3.value||"").trim();
        if(v === ANSWERS.p3){
          if(!state.solved.p3){
            state.solved.p3 = true;
            state.keys.k3 = KEYS.k3;
            unlockItem(3);
            updateProgress();
            writeLog(`퍼즐 ③ 해결! 키 3을 획득했다. (키3: ${state.keys.k3})`, "good");
          }else{
            writeLog("퍼즐 ③은 이미 해결했어.", "info");
          }
          setStatus(p3status, "good", "퍼즐 ③ 성공", "키 3이 인벤토리에 추가됐다.");
        }else{
          writeLog("퍼즐 ③ 오답. B→D→A→C 를 숫자로 변환해.", "bad");
          setStatus(p3status, "bad", "퍼즐 ③ 오답", "A=1 B=2 C=3 D=4 매핑 후 순서대로.");
          shake($("card3"));
        }
      }

      // ---------- Door ----------
      function tryDoor(){
        const v1 = (k1.value||"").trim();
        const v2 = (k2.value||"").trim().toUpperCase();
        const v3 = (k3.value||"").trim();
        const ok = (v1===KEYS.k1 && v2===KEYS.k2 && v3===KEYS.k3);

        if(ok){
          setStatus(doorStatus, "good", "상태: 해제 완료", "문이 열렸다! 축하해. (리셋하면 다시 가능)");
          writeLog("LOCK-3 해제 성공! 문이 열렸다.", "good");
          celebrate();
          state.running = false;
        }else{
          setStatus(doorStatus, "bad", "상태: 실패", "키가 틀렸다. 인벤토리를 확인하거나 퍼즐을 다시 풀어.");
          writeLog("잠금 해제 실패. 키 조합이 맞지 않아.", "bad");
          shake($("cardDoor"));
        }
      }

      // ---------- Modal ----------
      function openModal(){ modal.classList.add("open"); }
      function closeModal(){ modal.classList.remove("open"); }
      btnHelp.addEventListener("click", openModal);
      btnClose.addEventListener("click", closeModal);
      modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

      btnHintFill.addEventListener("click", ()=>{
        if(state.hintUsed){
          writeLog("힌트 자동 채우기는 이미 사용했어.", "warn");
          return;
        }
        state.hintUsed = true;
        p1.value = ANSWERS.p1;
        p2.value = ANSWERS.p2;
        p3.value = ANSWERS.p3;
        writeLog("힌트로 퍼즐 입력칸을 자동 채웠어. 이제 확인 버튼을 눌러봐.", "warn");
        closeModal();
      });

      // ---------- Inventory click ----------
      inv.addEventListener("click", (e)=>{
        const it = e.target.closest(".item");
        if(!it) return;
        if(it.classList.contains("locked")) return;

        const n = Number(it.dataset.item);
        autoFillDoor(n);

        const detail = n===1 ? `키 1은 프린터의 “다음 줄”을 시간+칸수로 만든 값이야: ${KEYS.k1}`
                    : n===2 ? `키 2는 문장의 세 번째 단어야: ${KEYS.k2}`
                    : `키 3은 스위치 순서를 숫자로 쓴 값이야: ${KEYS.k3}`;
        $("helpContent").innerHTML = `<b>키 ${n} 상세</b><br/>${detail}<br/><br/>이 키를 출입문 패널에 입력해서 잠금을 풀어.`;
        openModal();
      });

      // ---------- Reset ----------
      function resetAll(){
        state.timerSec = 15*60;
        state.running = true;
        state.solved = { p1:false, p2:false, p3:false };
        state.keys = { k1:"", k2:"", k3:"" };
        state.hintUsed = false;
        timeEl.textContent = formatTime(state.timerSec);
        progressEl.textContent = "0/3";
        doorBtn.disabled = false;
        doorBtn.classList.remove("locked");

        p1.value=""; p2.value=""; p3.value="";
        k1.value=""; k2.value=""; k3.value="";

        it1.classList.add("locked");
        it2.classList.add("locked");
        it3.classList.add("locked");
        [it1,it2,it3].forEach((it)=>{
          const ico = it.querySelector(".ico");
          ico.style.background = "rgba(122,162,255,.12)";
          ico.style.borderColor = "rgba(122,162,255,.25)";
          ico.style.color = "var(--accent)";
        });

        setStatus(p1status, "", "목표", "규칙대로 다음 줄을 예측해 숫자로 입력.");
        setStatus(p2status, "", "목표", "문장 속 세 번째 단어만 입력.");
        setStatus(p3status, "", "목표", "문자→숫자 변환 후 순서대로.");
        setStatus(doorStatus, "", "상태", "잠김. 3개 키가 모두 맞으면 문이 열린다.");

        logEl.textContent = "";
        writeLog("리셋 완료. 다시 시작해.", "info");
      }

      // ---------- Wire up ----------
      p1btn.addEventListener("click", checkP1);
      p2btn.addEventListener("click", checkP2);
      p3btn.addEventListener("click", checkP3);

      doorBtn.addEventListener("click", tryDoor);

      // Enter key triggers
      [p1,p2,p3,k1,k2,k3].forEach((inp)=>{
        inp.addEventListener("keydown", (e)=>{
          if(e.key !== "Enter") return;
          if(inp===p1) checkP1();
          else if(inp===p2) checkP2();
          else if(inp===p3) checkP3();
          else tryDoor();
        });
      });

      btnReset.addEventListener("click", resetAll);

      // ---------- Init ----------
      writeLog("잠긴 서버실에 들어왔다. 단서를 찾아 LOCK-3를 풀어라.", "info");
      writeLog("힌트 버튼은 언제든 열 수 있어. (자동 채우기 1회)", "info");
    })();
  </script>
</body>
</html>

